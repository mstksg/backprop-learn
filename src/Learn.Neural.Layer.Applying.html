<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances     #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE GADTs                 #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes            #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications      #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies          #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeInType            #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Layer</span><span class="hs-operator">.</span><span class="hs-identifier">Applying</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>    </span><a href="Learn.Neural.Layer.Applying.html#Applying"><span class="hs-identifier hs-type">Applying</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Applying.html#TensorOp"><span class="hs-identifier hs-type">TensorOp</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Applying.html#CommonOp"><span class="hs-identifier hs-type">CommonOp</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Applying.html#SoftMax"><span class="hs-identifier hs-type">SoftMax</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Reflection</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Learn.Neural.Layer.html"><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Layer</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="Numeric.BLAS.html"><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">BLAS</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">data</span><span> </span><a name="Applying"><a href="Learn.Neural.Layer.Applying.html#Applying"><span class="hs-identifier">Applying</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679217854"><span class="hs-identifier hs-type">k</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">newtype</span><span> </span><a name="TensorOp"><a href="Learn.Neural.Layer.Applying.html#TensorOp"><span class="hs-identifier">TensorOp</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-29"></a><span>    </span><a name="TF"><a href="Learn.Neural.Layer.Applying.html#TF"><span class="hs-identifier">TF</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span> </span><a name="getTensorOp"><a href="Learn.Neural.Layer.Applying.html#getTensorOp"><span class="hs-identifier">getTensorOp</span></a></a><span>
</span><a name="line-30"></a><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679217852"><a href="#local-6989586621679217852"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679217853"><a href="#local-6989586621679217853"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.html#BLAS"><span class="hs-identifier hs-type">BLAS</span></a><span> </span><a href="#local-6989586621679217852"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679217852"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679217850"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679217852"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679217851"><span class="hs-identifier hs-type">o</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">OpB</span><span> </span><a href="#local-6989586621679217853"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-char">'[ b i ] '[ b o ]
          }
       -&gt; TensorOp i o

instance Num (CParam (Applying s) b i o) where
    _ + _         = AppP
    _ * _         = AppP
    _ - _         = AppP
    negate _      = AppP
    abs    _      = AppP
    signum _      = AppP
    fromInteger _ = AppP

instance Fractional (CParam (Applying s) b i o) where
    _ / _          = AppP
    recip _        = AppP
    fromRational _ = AppP

instance Num (CState (Applying s) b i o) where
    _ + _         = AppS
    _ * _         = AppS
    _ - _         = AppS
    negate _      = AppS
    abs    _      = AppS
    signum _      = AppS
    fromInteger _ = AppS

instance Fractional (CState (Applying s) b i o) where
    _ / _          = AppS
    recip _        = AppS
    fromRational _ = AppS

instance (BLAS b, Reifies s (TensorOp i o), SingI i, SingI o) =&gt; Component (Applying s) b i o where
    data CParam (Applying s) b i o = AppP
    data CState (Applying s) b i o = AppS
    data CConf  (Applying s) b i o = AppC

    componentOp = componentOpDefault

    initParam _ _ _ _ = return AppP
    initState _ _ _ _ = return AppS
    defConf           = AppC

instance (BLAS b, Reifies s (TensorOp i o), SingI i, SingI o) =&gt; ComponentFF (Applying s) b i o where
    componentOpFF = bpOp . withInps $ \(x :&lt; _ :&lt; &#216;) -&gt; do
        y &lt;- getTensorOp to ~$ (x :&lt; &#216;)
        return . only $ y
      where
        to :: TensorOp i o
        to = reflect (Proxy @s)

instance (BLAS b, Reifies s (TensorOp i o), SingI i, SingI o) =&gt; ComponentLayer r (Applying s) b i o where
    componentRunMode = RMIsFF

data CommonOp :: Type where
    TO_Softmax :: [Nat] -&gt; CommonOp

instance SingI i =&gt; Reifies ('TO_Softmax i) (TensorOp i i) where
    reflect _ = TF $ bpOp . withInps $ \(x :&lt; &#216;) -&gt; do
      expX &lt;- tmapOp exp ~$ (x :&lt; &#216;)
      totX &lt;- tsumOp     ~$ (expX   :&lt; &#216;)
      sm   &lt;- scaleOp    ~$ (1/totX :&lt; expX :&lt; &#216;)
      return $ only sm

type SoftMax i = Applying ('TO_Softmax i)
</span></pre></body></html>