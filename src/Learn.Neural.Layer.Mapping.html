<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes   #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ConstraintKinds       #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DataKinds             #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric         #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances     #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE GADTs                 #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE InstanceSigs          #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase            #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes            #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving    #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications      #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies          #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE TypeInType            #-}</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators         #-}</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Layer</span><span class="hs-operator">.</span><span class="hs-identifier">Mapping</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-20"></a><span>    </span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#IdentMap"><span class="hs-identifier hs-type">IdentMap</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#ScaleMap"><span class="hs-identifier hs-type">ScaleMap</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#LogitMap"><span class="hs-identifier hs-type">LogitMap</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#ReLUMap"><span class="hs-identifier hs-type">ReLUMap</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#ReLUpMap"><span class="hs-identifier hs-type">ReLUpMap</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#ELUMap"><span class="hs-identifier hs-type">ELUMap</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#ELUpMap"><span class="hs-identifier hs-type">ELUpMap</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapFunc"><span class="hs-identifier hs-type">MapFunc</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#PMapping"><span class="hs-identifier hs-type">PMapping</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonPMap"><span class="hs-identifier hs-type">CommonPMap</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#PReLUMap"><span class="hs-identifier hs-type">PReLUMap</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#PELUMap"><span class="hs-identifier hs-type">PELUMap</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#PMapFunc"><span class="hs-identifier hs-type">PMapFunc</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Proxy</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Reflection</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Traversable</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Conjunction</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-keyword">hiding</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head'</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Generics</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><a href="Learn.Neural.Layer.html"><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Layer</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><a href="Numeric.BLAS.html"><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">BLAS</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span class="hs-operator">.</span><span class="hs-identifier">Iso</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span class="hs-operator">.</span><span class="hs-identifier">Op</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Statistics</span><span class="hs-operator">.</span><span class="hs-identifier">Distribution</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Statistics</span><span class="hs-operator">.</span><span class="hs-identifier">Distribution</span><span class="hs-operator">.</span><span class="hs-identifier">Uniform</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Higher</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Known</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Witness</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Nat</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TCN</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Generics</span><span class="hs-operator">.</span><span class="hs-identifier">SOP</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SOP</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Family</span><span class="hs-operator">.</span><span class="hs-identifier">Nat</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TCN</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-keyword">data</span><span> </span><a name="Mapping"><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier">Mapping</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679310592"><span class="hs-identifier hs-type">k</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-keyword">newtype</span><span> </span><a name="MapFunc"><a href="Learn.Neural.Layer.Mapping.html#MapFunc"><span class="hs-identifier">MapFunc</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-59"></a><span>    </span><a name="MF"><a href="Learn.Neural.Layer.Mapping.html#MF"><span class="hs-identifier">MF</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span> </span><a name="runMapFunc"><a href="Learn.Neural.Layer.Mapping.html#runMapFunc"><span class="hs-identifier">runMapFunc</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679310591"><a href="#local-6989586621679310591"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">RealFloat</span><span> </span><a href="#local-6989586621679310591"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679310591"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679310591"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-61"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapFunc"><span class="hs-identifier hs-type">MapFunc</span></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.html#CParam"><span class="hs-identifier hs-type">CParam</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310716"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310717"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310718"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310718"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-64"></a><span>    </span><span class="hs-identifier">_</span><span> </span><a name="local-8214565720323787265"><span class="hs-operator">+</span></a><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-identifier">_</span><span> </span><a name="local-8214565720323787264"><span class="hs-operator">*</span></a><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-66"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-67"></a><span>    </span><a name="local-3458764513820541097"><span class="hs-identifier">negate</span></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-68"></a><span>    </span><a name="local-8214565720323787260"><span class="hs-identifier">abs</span></a><span>    </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-69"></a><span>    </span><a name="local-8214565720323787261"><span class="hs-identifier">signum</span></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-70"></a><span>    </span><a name="local-3458764513820541088"><span class="hs-identifier">fromInteger</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Fractional</span><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.html#CParam"><span class="hs-identifier hs-type">CParam</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310713"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310714"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310715"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310715"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-identifier">_</span><span> </span><a name="local-8214565720323787263"><span class="hs-operator">/</span></a><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-74"></a><span>    </span><a name="local-8214565720323787259"><span class="hs-identifier">recip</span></a><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-75"></a><span>    </span><a name="local-3458764513820541090"><span class="hs-identifier">fromRational</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Floating</span><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.html#CParam"><span class="hs-identifier hs-type">CParam</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310710"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310711"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310712"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310712"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-78"></a><span>    </span><a name="local-8214565720323787256"><span class="hs-identifier">sqrt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.html#CState"><span class="hs-identifier hs-type">CState</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310707"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310708"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310709"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310709"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-identifier">_</span><span> </span><a name="local-8214565720323787265"><span class="hs-operator">+</span></a><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-identifier">_</span><span> </span><a name="local-8214565720323787264"><span class="hs-operator">*</span></a><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-83"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-84"></a><span>    </span><a name="local-3458764513820541097"><span class="hs-identifier">negate</span></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-85"></a><span>    </span><a name="local-8214565720323787260"><span class="hs-identifier">abs</span></a><span>    </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-86"></a><span>    </span><a name="local-8214565720323787261"><span class="hs-identifier">signum</span></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-87"></a><span>    </span><a name="local-3458764513820541088"><span class="hs-identifier">fromInteger</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Fractional</span><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.html#CState"><span class="hs-identifier hs-type">CState</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310704"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310705"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310706"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310706"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-identifier">_</span><span> </span><a name="local-8214565720323787263"><span class="hs-operator">/</span></a><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-91"></a><span>    </span><a name="local-8214565720323787259"><span class="hs-identifier">recip</span></a><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-92"></a><span>    </span><a name="local-3458764513820541090"><span class="hs-identifier">fromRational</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Floating</span><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.html#CState"><span class="hs-identifier hs-type">CState</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310701"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310702"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310703"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310703"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-95"></a><span>    </span><a name="local-8214565720323787256"><span class="hs-identifier">sqrt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.html#BLAS"><span class="hs-identifier hs-type">BLAS</span></a><span> </span><a href="#local-6989586621679310698"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Reifies</span><span> </span><a href="#local-6989586621679310699"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapFunc"><span class="hs-identifier hs-type">MapFunc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Learn.Neural.Layer.html#Component"><span class="hs-identifier hs-type">Component</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310699"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310698"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">CParam</span><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310699"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310698"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MapP"><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier">MapP</span></a></a><span>
</span><a name="line-99"></a><span>    </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">CState</span><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310699"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310698"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MapS"><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier">MapS</span></a></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">CConf</span><span>  </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310699"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310698"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310700"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MapC"><a href="Learn.Neural.Layer.Mapping.html#MapC"><span class="hs-identifier">MapC</span></a></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>    </span><a name="local-8214565720323985895"><a href="Learn.Neural.Layer.html#componentOp"><span class="hs-identifier">componentOp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.html#componentOpDefault"><span class="hs-identifier hs-var">componentOpDefault</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>    </span><a name="local-8214565720323985896"><a href="Learn.Neural.Layer.html#initParam"><span class="hs-identifier">initParam</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapP"><span class="hs-identifier hs-var">MapP</span></a><span>
</span><a name="line-105"></a><span>    </span><a name="local-8214565720323985897"><a href="Learn.Neural.Layer.html#initState"><span class="hs-identifier">initState</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapS"><span class="hs-identifier hs-var">MapS</span></a><span>
</span><a name="line-106"></a><span>    </span><a name="local-8214565720323985898"><a href="Learn.Neural.Layer.html#defConf"><span class="hs-identifier">defConf</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapC"><span class="hs-identifier hs-var">MapC</span></a><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.html#BLAS"><span class="hs-identifier hs-type">BLAS</span></a><span> </span><a href="#local-6989586621679310692"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Reifies</span><span> </span><a href="#local-6989586621679310693"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapFunc"><span class="hs-identifier hs-type">MapFunc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679310694"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Learn.Neural.Layer.html#ComponentFF"><span class="hs-identifier hs-type">ComponentFF</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310693"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310692"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310694"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310694"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-109"></a><span>    </span><a name="local-8214565720323985889"><a href="Learn.Neural.Layer.html#componentOpFF"><span class="hs-identifier">componentOpFF</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bpOp</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">withInps</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679310696"><a href="#local-6989586621679310696"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-identifier hs-var">&#216;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-110"></a><span>        </span><a name="local-6989586621679310697"><a href="#local-6989586621679310697"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Numeric.Tensor.html#tmapOp"><span class="hs-identifier hs-var">tmapOp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">runMapFunc</span><span> </span><a href="#local-6989586621679310695"><span class="hs-identifier hs-var">mf</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">~$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679310696"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-identifier hs-var">&#216;</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">only</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679310697"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-112"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-identifier">mf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapFunc"><span class="hs-identifier hs-type">MapFunc</span></a><span>
</span><a name="line-114"></a><span>        </span><a name="local-6989586621679310695"><a href="#local-6989586621679310695"><span class="hs-identifier">mf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reflect</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679310693"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.html#BLAS"><span class="hs-identifier hs-type">BLAS</span></a><span> </span><a href="#local-6989586621679310688"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Reifies</span><span> </span><a href="#local-6989586621679310689"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="Learn.Neural.Layer.Mapping.html#MapFunc"><span class="hs-identifier hs-type">MapFunc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679310690"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Learn.Neural.Layer.html#ComponentLayer"><span class="hs-identifier hs-type">ComponentLayer</span></a><span> </span><a href="#local-6989586621679310691"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-special">(</span><a href="Learn.Neural.Layer.Mapping.html#Mapping"><span class="hs-identifier hs-type">Mapping</span></a><span> </span><a href="#local-6989586621679310689"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679310688"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679310690"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679310690"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-117"></a><span>    </span><a name="local-8214565720323985887"><a href="Learn.Neural.Layer.html#componentRunMode"><span class="hs-identifier">componentRunMode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Learn.Neural.Layer.html#RMIsFF"><span class="hs-identifier hs-var">RMIsFF</span></a><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">data</span><span> </span><a name="CommonMap"><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier">CommonMap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-120"></a><span>    </span><a name="MF_Ident"><a href="Learn.Neural.Layer.Mapping.html#MF_Ident"><span class="hs-identifier">MF_Ident</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span>
</span><a name="line-121"></a><span>    </span><a name="MF_Scale"><a href="Learn.Neural.Layer.Mapping.html#MF_Scale"><span class="hs-identifier">MF_Scale</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679310588"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span>
</span><a name="line-122"></a><span>    </span><a name="MF_Logit"><a href="Learn.Neural.Layer.Mapping.html#MF_Logit"><span class="hs-identifier">MF_Logit</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span>
</span><a name="line-123"></a><span>    </span><a name="MF_Tanh"><a href="Learn.Neural.Layer.Mapping.html#MF_Tanh"><span class="hs-identifier">MF_Tanh</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span>
</span><a name="line-124"></a><span>    </span><a name="MF_ReLU"><a href="Learn.Neural.Layer.Mapping.html#MF_ReLU"><span class="hs-identifier">MF_ReLU</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span>
</span><a name="line-125"></a><span>    </span><a name="MF_ReLUp"><a href="Learn.Neural.Layer.Mapping.html#MF_ReLUp"><span class="hs-identifier">MF_ReLUp</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679310589"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span>
</span><a name="line-126"></a><span>    </span><a name="MF_ELU"><a href="Learn.Neural.Layer.Mapping.html#MF_ELU"><span class="hs-identifier">MF_ELU</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span>
</span><a name="line-127"></a><span>    </span><a name="MF_ELUp"><a href="Learn.Neural.Layer.Mapping.html#MF_ELUp"><span class="hs-identifier">MF_ELUp</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679310590"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Learn.Neural.Layer.Mapping.html#CommonMap"><span class="hs-identifier hs-type">CommonMap</span></a><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Reifies</span><span> </span><span class="hs-char">'MF_Ident MapFunc where
    reflect _ = MF id
instance Reifies s Double =&gt; Reifies ('MF_Scale s) MapFunc where
    reflect _ = MF $ (realToFrac &#945; *)
      where
        &#945; :: Double
        &#945; = reflect (Proxy @s)
instance Reifies 'MF_Logit MapFunc where
    reflect _ = MF $ \x -&gt; 1 / (1 + exp (-x))
instance Reifies 'MF_Tanh MapFunc where
    reflect _ = MF tanh
instance Reifies 'MF_ReLU MapFunc where
    reflect _ = MF $ \x -&gt; if x &lt; 0 then 0 else x
instance Reifies s Double =&gt; Reifies ('MF_ReLUp s) MapFunc where
    reflect _ = MF $ \x -&gt; if x &lt; 0 then realToFrac &#945; * x else x
      where
        &#945; :: Double
        &#945; = reflect (Proxy @s)
instance Reifies 'MF_ELU MapFunc where
    reflect _ = MF $ \x -&gt; if x &lt; 0 then exp x - 1 else x
instance Reifies s Double =&gt; Reifies ('MF_ELUp s) MapFunc where
    reflect _ = MF $ \x -&gt; if x &lt; 0 then realToFrac &#945; * (exp x - 1) else x
      where
        &#945; :: Double
        &#945; = reflect (Proxy @s)

type IdentMap   = Mapping 'MF_Ident
type ScaleMap s = Mapping ('MF_Scale s)
type LogitMap   = Mapping 'MF_Logit
type TanhMap    = Mapping 'MF_Tanh
type ReLUMap    = Mapping 'MF_ReLU
type ReLUpMap s = Mapping ('MF_ReLUp s)
type ELUMap     = Mapping 'MF_ELU
type ELUpMap s  = Mapping ('MF_ELUp s)

data PMapping :: k -&gt; TCN.N -&gt; Type

data PMapFunc :: TCN.N -&gt; Type where
    PMF :: { runPMapFunc :: (forall a. RealFloat a =&gt; (I :&amp;: Vec n) a -&gt; a)
           , getPMapDef  :: Vec n (SomeC ContGen I)
           }
        -&gt; PMapFunc n

instance (Tensor b, Known TCN.Nat n) =&gt; Num (CParam (PMapping s n) b i i) where
    PMapP x + PMapP y = PMapP $ x + y
    PMapP x - PMapP y = PMapP $ x - y
    PMapP x * PMapP y = PMapP $ x * y
    negate (PMapP x) = PMapP (negate x)
    abs    (PMapP x) = PMapP (abs    x)
    signum (PMapP x) = PMapP (signum x)
    fromInteger x         = PMapP (fromInteger x)

-- until Vec has a Fractional instance
instance (Tensor b, Known TCN.Nat n) =&gt; Fractional (CParam (PMapping s n) b i i) where
    PMapP x / PMapP y = PMapP $ liftA2 (/) x y
    recip (PMapP x)   = PMapP $ fmap recip x
    fromRational x    = PMapP $ pure (fromRational x)

instance (Tensor b, Known TCN.Nat n) =&gt; Floating (CParam (PMapping s n) b i i) where
    sqrt (PMapP x)   = PMapP $ fmap sqrt x

instance Num (CState (PMapping s n) b i i) where
    _ + _         = PMapS
    _ * _         = PMapS
    _ - _         = PMapS
    negate _      = PMapS
    abs    _      = PMapS
    signum _      = PMapS
    fromInteger _ = PMapS

instance Fractional (CState (PMapping s n) b i i) where
    _ / _          = PMapS
    recip _        = PMapS
    fromRational _ = PMapS

instance Floating (CState (PMapping s n) b i i) where
    sqrt _        = PMapS

pMapP :: Known TCN.Nat n =&gt; Iso' (CParam (PMapping s n) b i i) (Tuple (Replicate n (Scalar b)))
pMapP = gTuple . iso (vecToProd . getI . head') (only_ . prodToVec' known)

deriving instance Generic (CParam (PMapping s n) b i i)
instance SOP.Generic (CParam (PMapping s n) b i i)

instance (BLAS b, Reifies s (PMapFunc n), SingI i, Known TCN.Nat n) =&gt; Component (PMapping s n) b i i where
    data CParam (PMapping s n) b i i = PMapP { _getPMapP :: !(Vec n (Scalar b)) }
    data CState (PMapping s n) b i i = PMapS
    data CConf  (PMapping s n) b i i = PMapC { _getPMapC :: !(Vec n (SomeC ContGen I)) }

    componentOp = componentOpDefault

    initParam _ _ c g = do
        ps &lt;- forM (_getPMapC c) $ \(SomeC (I d)) -&gt;
          realToFrac &lt;$&gt; genContVar d g
        return $ PMapP ps
    initState _ _ _ _ = return PMapS

    defConf = PMapC (getPMapDef pmf)
      where
        pmf :: PMapFunc n
        pmf = reflect (Proxy @s)

instance (BLAS b, Reifies s (PMapFunc n), SingI i, Known TCN.Nat n) =&gt; ComponentFF (PMapping s n) b i i where
    componentOpFF
        :: forall q. Num (b i)
        =&gt; OpB q '[b i, CParam (PMapping s n) b i i] '[b i]
    componentOpFF = bpOp . withInps $ \(x :&lt; mp :&lt; &#216;) -&gt; replWit @n @Num @(Scalar b) n Wit //
                                                         replLen @n @(Scalar b) n          // do
        ps :: Prod (BVar q '[b i, CParam (PMapping s n) b i i]) (Replicate n (Scalar b))
          &lt;- replWit @n @Num @(Scalar b) n Wit //
             replLen @n @(Scalar b) n //
               pMapP #&lt;~ mp
        let psV :: VecT n (BVar q '[b i, CParam (PMapping s n) b i i]) (Scalar b)
            psV = prodToVec' n ps
        psTV :: VecT n (BVar q '[b i, CParam (PMapping s n) b i i]) (b i)
          &lt;- vtraverse (\p -&gt; tkonstOp sing ~$ (p :&lt; &#216;)) psV
        let psT :: Prod (BVar q '[b i, CParam (PMapping s n) b i i]) (Replicate n (b i))
            psT = vecToProd psTV
        y &lt;- tzipNOp @_ @_ @('TCN.S n) (\case x' :* psT' -&gt; runPMapFunc pmf (x' :&amp;: psT'))
               ~$ (x :&lt; psT)
        return $ only y
      where
        n :: TCN.Nat n
        n = known
        pmf :: PMapFunc n
        pmf = reflect (Proxy @s)

instance (BLAS b, Reifies s (PMapFunc n), SingI i, Known TCN.Nat n) =&gt; ComponentLayer r (PMapping s n) b i i where
    componentRunMode = RMIsFF

data CommonPMap :: Type where
    PMF_PReLU :: CommonPMap
    PMF_PELU  :: CommonPMap

instance Reifies 'PMF_PReLU (PMapFunc TCN.N1) where
    reflect _ = PMF (\case I x :&amp;: (I &#945; :* &#216;V) -&gt;
                            if x &lt; 0 then &#945; * x else x)
                    (SomeC (I (uniformDistr 0 1)) :+ &#216;V)

instance Reifies 'PMF_PELU (PMapFunc TCN.N1) where
    reflect _ = PMF (\case I x :&amp;: (I &#945; :* &#216;V) -&gt;
                            if x &lt; 0 then &#945; * (exp x - 1) else x)
                    (SomeC (I (uniformDistr 0 1)) :+ &#216;V)

type PReLUMap = PMapping 'PMF_PReLU
type PELUMap  = PMapping 'PMF_PELU
</span></pre></body></html>