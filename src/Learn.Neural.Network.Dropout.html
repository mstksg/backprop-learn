<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds            #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts     #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances    #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE GADTs                #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures       #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase           #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables  #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE Strict               #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications     #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeInType           #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators        #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Dropout</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-15"></a><span>    </span><a href="Learn.Neural.Network.Dropout.html#Dropout"><span class="hs-identifier hs-type">Dropout</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Network.Dropout.html#NetworkDO"><span class="hs-identifier hs-type">NetworkDO</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Network.Dropout.html#netOpDO"><span class="hs-identifier hs-var">netOpDO</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Network.Dropout.html#konstDO"><span class="hs-identifier hs-var">konstDO</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Network.Dropout.html#konstDO%27"><span class="hs-identifier hs-var">konstDO'</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Network.Dropout.html#mapDO"><span class="hs-identifier hs-var">mapDO</span></a><span class="hs-special">,</span><span> </span><a href="Learn.Neural.Network.Dropout.html#zipDO"><span class="hs-identifier hs-var">zipDO</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Primitive</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bool</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Product</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><a href="Learn.Neural.Layer.html"><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Layer</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><a href="Learn.Neural.Network.html"><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><a href="Numeric.BLAS.html"><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">BLAS</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span class="hs-operator">.</span><span class="hs-identifier">Op</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span class="hs-operator">.</span><span class="hs-identifier">MWC</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span class="hs-operator">.</span><span class="hs-identifier">MWC</span><span class="hs-operator">.</span><span class="hs-identifier">Distributions</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Known</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">data</span><span> </span><a name="NetworkDO"><a href="Learn.Neural.Network.Dropout.html#NetworkDO"><span class="hs-identifier">NetworkDO</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Layer.html#RunMode"><span class="hs-identifier hs-type">RunMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Learn.Neural.Network.html#LChain"><span class="hs-identifier hs-type">LChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Learn.Neural.Network.html#LChain"><span class="hs-identifier hs-type">LChain</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-39"></a><span>    </span><a name="NDO"><a href="Learn.Neural.Network.Dropout.html#NDO"><span class="hs-identifier">NDO</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span> </span><a name="ndoDropout"><a href="Learn.Neural.Network.Dropout.html#ndoDropout"><span class="hs-identifier">ndoDropout</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Learn.Neural.Network.Dropout.html#Dropout"><span class="hs-identifier hs-type">Dropout</span></a><span> </span><a href="#local-6989586621679541146"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="#local-6989586621679541147"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679541148"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679541149"><span class="hs-identifier hs-type">hs</span></a><span> </span><a href="#local-6989586621679541150"><span class="hs-identifier hs-type">o</span></a><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>           </span><span class="hs-special">,</span><span> </span><a name="ndoNetwork"><a href="Learn.Neural.Network.Dropout.html#ndoNetwork"><span class="hs-identifier">ndoNetwork</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Learn.Neural.Network.html#Network"><span class="hs-identifier hs-type">Network</span></a><span> </span><a href="#local-6989586621679541146"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="#local-6989586621679541147"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679541148"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679541149"><span class="hs-identifier hs-type">hs</span></a><span> </span><a href="#local-6989586621679541150"><span class="hs-identifier hs-type">o</span></a><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-42"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Learn.Neural.Network.Dropout.html#NetworkDO"><span class="hs-identifier hs-type">NetworkDO</span></a><span> </span><a href="#local-6989586621679541146"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="#local-6989586621679541147"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679541148"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="#local-6989586621679541149"><span class="hs-identifier hs-type">hs</span></a><span> </span><a href="#local-6989586621679541150"><span class="hs-identifier hs-type">o</span></a><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-comment">-- | For something like</span><span>
</span><a name="line-45"></a><span class="hs-comment">--</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- l1 ':&amp;' l2 :&amp; 'NetExt' l3</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-49"></a><span class="hs-comment">--</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- you could have</span><span>
</span><a name="line-51"></a><span class="hs-comment">--</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- 0.2 ':&amp;%' 0.3 :&amp;% DOExt</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-55"></a><span class="hs-comment">--</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- Would would represent a 20% dropout after @l1@ and a 30% dropout after</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- @l2@.  By conscious design decision, 'DOExt' does not take any dropout</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- rate, and it is therefore impossible to have dropout after the final</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- layer before the output.  It is also not possible to have dropout before</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- the first layer, after the input.</span><span>
</span><a name="line-61"></a><span class="hs-keyword">data</span><span> </span><a name="Dropout"><a href="Learn.Neural.Network.Dropout.html#Dropout"><span class="hs-identifier">Dropout</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Layer.html#RunMode"><span class="hs-identifier hs-type">RunMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Learn.Neural.Network.html#LChain"><span class="hs-identifier hs-type">LChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Learn.Neural.Network.html#LChain"><span class="hs-identifier hs-type">LChain</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-62"></a><span>    </span><a name="DOExt"><a href="Learn.Neural.Network.Dropout.html#DOExt"><span class="hs-identifier">DOExt</span></a></a><span>
</span><a name="line-63"></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Learn.Neural.Network.Dropout.html#Dropout"><span class="hs-identifier hs-type">Dropout</span></a><span> </span><a href="#local-6989586621679541133"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="#local-6989586621679541134"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679541135"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-operator">:~</span><span> </span><a href="#local-6989586621679541136"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-char">'[] o
    (:&amp;%)
        :: (Num (b h), SingI h)
        =&gt; !Double
        -&gt; !(Dropout r b (h :~ d) hs o)
        -&gt; Dropout r b (i :~ c) ((h :~ d) ': hs) o

infixr 4 :&amp;%

instance Known (NetStruct r b (i :~ c) hs) o =&gt; Num (Dropout r b (i :~ c) hs o) where
    (+) = zipDO (+)
    (-) = zipDO (-)
    (*) = zipDO (*)
    negate = mapDO negate
    signum = mapDO signum
    abs    = mapDO abs
    fromInteger = konstDO' . fromInteger

konstDO
    :: forall r b i hs o. ()
    =&gt; NetStruct r b i hs o
    -&gt; Double
    -&gt; Dropout r b i hs o
konstDO s0 x = go s0
  where
    go :: NetStruct r b j js o -&gt; Dropout r b j js o
    go = \case
      NSExt   -&gt; DOExt
      NSInt s -&gt; x :&amp;% go s

konstDO'
    :: forall r b i hs o. Known (NetStruct r b i hs) o
    =&gt; Double
    -&gt; Dropout r b i hs o
konstDO' = konstDO known

mapDO
    :: forall r b i hs o. ()
    =&gt; (Double -&gt; Double)
    -&gt; Dropout r b i hs o
    -&gt; Dropout r b i hs o
mapDO f = go
  where
    go :: Dropout r b j js o -&gt; Dropout r b j js o
    go = \case
      DOExt   -&gt; DOExt
      x :&amp;% d -&gt; f x :&amp;% go d
      
zipDO
    :: forall r b i hs o. ()
    =&gt; (Double -&gt; Double -&gt; Double)
    -&gt; Dropout r b i hs o
    -&gt; Dropout r b i hs o
    -&gt; Dropout r b i hs o
zipDO f = go
  where
    go :: Dropout r b j js o -&gt; Dropout r b j js o -&gt; Dropout r b j js o
    go = \case
      DOExt -&gt; \case
        DOExt -&gt; DOExt
      x :&amp;% dx -&gt; \case
        y :&amp;% dy -&gt; f x y :&amp;% go dx dy
      
netOpDO
    :: forall m b i c hs o r. (BLAS b, Num (b i), Num (b o), PrimMonad m, SingI o)
    =&gt; Dropout r b (i :~ c) hs o
    -&gt; Gen (PrimState m)
    -&gt; m (OpBS '[ Network r b (i :~ c) hs o, b i ] '[ Network r b (i :~ c) hs o, b o ])
netOpDO = \case
    DOExt -&gt; \_ -&gt; return $ OpBS $ OpM $ \(I n :&lt; I x :&lt; &#216;) -&gt; case n of
      NetExt (l :: Layer r c b i o) -&gt; do
        (I l' :&lt; I y :&lt; &#216;, gF) &lt;- runOpM' (layerOp @r @c @i @o @b) (l ::&lt; x ::&lt; &#216;)
        let gF' = fmap (\case I dL :&lt; I dX :&lt; &#216; -&gt; NetExt dL ::&lt; dX ::&lt; &#216;)
                . gF
                . (\case Just (NetExt dL) :&lt; dY :&lt; &#216; -&gt;
                           Just dL :&lt; dY :&lt; &#216;
                         Nothing          :&lt; dY :&lt; &#216; -&gt;
                           Nothing :&lt; dY :&lt; &#216;
                  )
        return (NetExt l' ::&lt; y ::&lt; &#216;, gF')
    r :&amp;% (d :: Dropout r b (h :~ d) js o) -&gt; \g -&gt; do
      mask &lt;- genA @b (sing @_ @h) $ \_ -&gt; bool (1 / (1 - realToFrac r)) 0 &lt;$&gt; bernoulli r g
      no :: OpBS '[ Network r b (h :~ d) js o, b h ] '[ Network r b (h :~ d) js o, b o ]
            &lt;- netOpDO @m @b @h @d @js @o @r d g
      return $ OpBS $ OpM $ \(I n :&lt; I x :&lt; &#216;) -&gt; case n of
        (l :: Layer r c b i h) :&amp; (n2 :: Network r b (h ':~ d) js o) -&gt; do
          (I l'  :&lt; I y :&lt; &#216;, gF ) &lt;- runOpM' (layerOp @r @c @i @h @b) (l  ::&lt; x ::&lt; &#216;)
          (I n2' :&lt; I z :&lt; &#216;, gF') &lt;- runOpM' (runOpBS no            ) (n2 ::&lt; y ::&lt; &#216;)
          let gF'' = \case Just (dL :&amp; dN) :&lt; dZ :&lt; &#216; -&gt; do
                             I dN2 :&lt; I dY :&lt; &#216; &lt;- gF' (Just dN :&lt; dZ       :&lt; &#216;)
                             let dY' = tzip (*) mask dY
                             I dL0 :&lt; I dX :&lt; &#216; &lt;- gF  (Just dL :&lt; Just dY' :&lt; &#216;)
                             return $ (dL0 :&amp; dN2) ::&lt; dX ::&lt; &#216;
                           Nothing         :&lt; dZ :&lt; &#216; -&gt; do
                             I dN2 :&lt; I dY :&lt; &#216; &lt;- gF' (Nothing :&lt; dZ       :&lt; &#216;)
                             let dY' = tzip (*) mask dY
                             I dL0 :&lt; I dX :&lt; &#216; &lt;- gF  (Nothing :&lt; Just dY' :&lt; &#216;)
                             return $ (dL0 :&amp; dN2) ::&lt; dX ::&lt; &#216;
          return ((l' :&amp; n2') ::&lt; z ::&lt; &#216;, gF'')
</span></pre></body></html>