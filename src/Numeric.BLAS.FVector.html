<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric       #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE InstanceSigs        #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures      #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">BLAS</span><span class="hs-operator">.</span><span class="hs-identifier">FVector</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>    </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Finite</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Finite</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Product</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Generics</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Lens</span><span class="hs-operator">.</span><span class="hs-identifier">Micro</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><a href="Numeric.BLAS.html"><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">BLAS</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><a href="Numeric.Tensor.html"><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Tensor</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Sized</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SV</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Unboxed</span><span>      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">VU</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">newtype</span><span> </span><a name="FV"><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier">FV</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-36"></a><span>    </span><a name="FV"><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier">FV</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span> </span><a name="getFV"><a href="Numeric.BLAS.FVector.html#getFV"><span class="hs-identifier">getFV</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VU</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-37"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-38"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span> </span><a href="#local-6989586621679705341"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">instance</span><span> </span><a href="Numeric.Tensor.html#Tensor"><span class="hs-identifier hs-type">Tensor</span></a><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-42"></a><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Scalar</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>    </span><a name="local-8214565720323932427"><a href="Numeric.Tensor.html#genA"><span class="hs-identifier">genA</span></a></a><span> </span><a name="local-6989586621679705420"><a href="#local-6989586621679705420"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679705421"><a href="#local-6989586621679705421"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="#local-6989586621679705421"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Numeric.BLAS.FVector.html#range"><span class="hs-identifier hs-var">range</span></a><span> </span><a href="#local-6989586621679705420"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-45"></a><span>    </span><a name="local-8214565720323932428"><a href="Numeric.Tensor.html#gen"><span class="hs-identifier">gen</span></a></a><span> </span><a name="local-6989586621679705422"><a href="#local-6989586621679705422"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679705423"><a href="#local-6989586621679705423"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679705423"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Numeric.BLAS.FVector.html#range"><span class="hs-identifier hs-var">range</span></a><span> </span><a href="#local-6989586621679705422"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-46"></a><span>    </span><a name="local-8214565720323932429"><a href="Numeric.Tensor.html#tkonst"><span class="hs-identifier">tkonst</span></a></a><span> </span><a name="local-6989586621679705424"><a href="#local-6989586621679705424"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">product</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromSing</span><span> </span><a href="#local-6989586621679705424"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>    </span><a name="local-8214565720323932430"><a href="Numeric.Tensor.html#tsum"><span class="hs-identifier">tsum</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getFV</span><span>
</span><a name="line-48"></a><span>    </span><a name="local-8214565720323932431"><a href="Numeric.Tensor.html#tmap"><span class="hs-identifier">tmap</span></a></a><span> </span><a name="local-6989586621679705425"><a href="#local-6989586621679705425"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679705425"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getFV</span><span>
</span><a name="line-49"></a><span>    </span><a name="local-8214565720323932432"><a href="Numeric.Tensor.html#tzip"><span class="hs-identifier">tzip</span></a></a><span> </span><a name="local-6989586621679705426"><a href="#local-6989586621679705426"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><a name="local-6989586621679705427"><a href="#local-6989586621679705427"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><a name="local-6989586621679705428"><a href="#local-6989586621679705428"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621679705426"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679705427"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679705428"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>    </span><span class="hs-identifier">tzipN</span><span>
</span><a name="line-51"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679705417"><a href="#local-6989586621679705417"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679705418"><a href="#local-6989586621679705418"><span class="hs-identifier">n</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679705417"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-52"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vec</span><span> </span><a href="#local-6989586621679705418"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VecT</span><span> </span><a href="#local-6989586621679705418"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span> </span><a href="#local-6989586621679705417"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-54"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span> </span><a href="#local-6989586621679705417"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-55"></a><span>    </span><a name="local-8214565720323932433"><a href="Numeric.Tensor.html#tzipN"><span class="hs-identifier">tzipN</span></a></a><span> </span><a name="local-6989586621679705429"><a href="#local-6989586621679705429"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679705430"><a href="#local-6989586621679705430"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">generate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679705431"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679705434"><a href="#local-6989586621679705434"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-56"></a><span>                   </span><span class="hs-special">(</span><a href="#local-6989586621679705429"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.!</span><span> </span><a href="#local-6989586621679705434"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679705432"><span class="hs-identifier hs-var">xs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-58"></a><span>        </span><a name="local-6989586621679705431"><a href="#local-6989586621679705431"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">product</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromSing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sing</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679705417"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>        </span><a name="local-6989586621679705432"><a href="#local-6989586621679705432"><span class="hs-identifier">xs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vmap</span><span> </span><span class="hs-identifier">getFV</span><span> </span><a href="#local-6989586621679705430"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span>    </span><a name="local-8214565720323932436"><a href="Numeric.Tensor.html#tslice"><span class="hs-identifier">tslice</span></a></a><span> </span><a name="local-6989586621679705435"><a href="#local-6989586621679705435"><span class="hs-identifier">p0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679705436"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">sing</span><span> </span><a href="#local-6989586621679705435"><span class="hs-identifier hs-var">p0</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getFV</span><span>
</span><a name="line-63"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-64"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-6989586621679705437"><span class="hs-identifier hs-type">ns</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ProdMap"><span class="hs-identifier hs-type">ProdMap</span></a><span> </span><a href="Numeric.Tensor.html#Slice"><span class="hs-identifier hs-type">Slice</span></a><span> </span><a href="#local-6989586621679705437"><span class="hs-identifier hs-type">ns</span></a><span> </span><a href="#local-6989586621679705438"><span class="hs-identifier hs-type">ms</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VU</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VU</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-65"></a><span>        </span><a name="local-6989586621679705436"><a href="#local-6989586621679705436"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-66"></a><span>          </span><span class="hs-identifier hs-var">SNil</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-67"></a><span>            </span><a href="Numeric.Tensor.html#PMZ"><span class="hs-identifier hs-var">PMZ</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-68"></a><span>          </span><span class="hs-identifier hs-var">SNat</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">SCons</span><span class="hs-special">`</span><span> </span><a name="local-6989586621679705439"><a href="#local-6989586621679705439"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-69"></a><span>            </span><a href="Numeric.Tensor.html#PMS"><span class="hs-identifier hs-var">PMS</span></a><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#Slice"><span class="hs-identifier hs-var">Slice</span></a><span> </span><a name="local-6989586621679705440"><a href="#local-6989586621679705440"><span class="hs-identifier">sL</span></a></a><span> </span><a name="local-6989586621679705441"><a href="#local-6989586621679705441"><span class="hs-identifier">sC</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679705442"><a href="#local-6989586621679705442"><span class="hs-identifier">pms</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-70"></a><span>              </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- some wasted work here in re-computing the product,</span><span>
</span><a name="line-71"></a><span>                  </span><span class="hs-comment">-- but premature optimization blah blah</span><span>
</span><a name="line-72"></a><span>                  </span><a name="local-6989586621679705443"><a href="#local-6989586621679705443"><span class="hs-identifier">innerSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">product</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromSing</span><span> </span><a href="#local-6989586621679705439"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>                  </span><a name="local-6989586621679705444"><a href="#local-6989586621679705444"><span class="hs-identifier">dropper</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679705443"><span class="hs-identifier hs-var">innerSize</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromSing</span><span> </span><a href="#local-6989586621679705440"><span class="hs-identifier hs-var">sL</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>                  </span><a name="local-6989586621679705445"><a href="#local-6989586621679705445"><span class="hs-identifier">taker</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679705443"><span class="hs-identifier hs-var">innerSize</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromSing</span><span> </span><a href="#local-6989586621679705441"><span class="hs-identifier hs-var">sC</span></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>              </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">over</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.FVector.html#chunks"><span class="hs-identifier hs-var">chunks</span></a><span> </span><a href="#local-6989586621679705443"><span class="hs-identifier hs-var">innerSize</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679705436"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679705439"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621679705442"><span class="hs-identifier hs-var">pms</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>                </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">slice</span><span> </span><a href="#local-6989586621679705444"><span class="hs-identifier hs-var">dropper</span></a><span> </span><a href="#local-6989586621679705445"><span class="hs-identifier hs-var">taker</span></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>    </span><a name="local-8214565720323932434"><a href="Numeric.Tensor.html#tindex"><span class="hs-identifier">tindex</span></a></a><span> </span><a name="local-6989586621679705446"><a href="#local-6989586621679705446"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><a name="local-6989586621679705447"><a href="#local-6989586621679705447"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679705447"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.!</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getFinite</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.FVector.html#reIndex"><span class="hs-identifier hs-var">reIndex</span></a><span> </span><a href="#local-6989586621679705446"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span>    </span><a name="local-8214565720323932437"><a href="Numeric.Tensor.html#treshape"><span class="hs-identifier">treshape</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><a name="local-6989586621679705448"><a href="#local-6989586621679705448"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><a href="#local-6989586621679705448"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-81"></a><span>    </span><a name="local-8214565720323932438"><a href="Numeric.Tensor.html#tload"><span class="hs-identifier">tload</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-var">FV</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">convert</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">SV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromSized</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-identifier">textract</span><span>
</span><a name="line-83"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679705419"><a href="#local-6989586621679705419"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679705419"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-84"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span> </span><a href="#local-6989586621679705419"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-85"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SV</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#Product"><span class="hs-identifier hs-type">Product</span></a><span> </span><a href="#local-6989586621679705419"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-86"></a><span>    </span><a name="local-8214565720323932439"><a href="Numeric.Tensor.html#textract"><span class="hs-identifier">textract</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withKnownNat</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#sProduct"><span class="hs-identifier hs-var">sProduct</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sing</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679705419"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-87"></a><span>      </span><span class="hs-identifier hs-var">fromJust</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">SV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toSized</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">VU</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">convert</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getFV</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-keyword">instance</span><span> </span><a href="Numeric.BLAS.html#BLAS"><span class="hs-identifier hs-type">BLAS</span></a><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>    </span><span class="hs-identifier">iamax</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679705382"><a href="#local-6989586621679705382"><span class="hs-identifier">n</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-6989586621679705382"><span class="hs-identifier hs-type">n</span></a><span>
</span><a name="line-93"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Numeric.BLAS.FVector.html#FV"><span class="hs-identifier hs-type">FV</span></a><span> </span><span class="hs-char">'[n + 1]
        -&gt; Finite (n + 1)
    iamax = withKnownNat (SNat @n %:+ SNat @1) $
        Finite . fromIntegral . VU.maxIndex . VU.map abs . getFV

    gemv
        :: forall m n. (KnownNat m, KnownNat n)
        =&gt; Double
        -&gt; FV '[m, n]
        -&gt; FV '[n]
        -&gt; Maybe (Double, FV '[m])
        -&gt; FV '[m]
    gemv &#945; (FV a) (FV x) b =
          FV
        . maybe id (\(&#946;, FV ys) -&gt; VU.zipWith (\y z -&gt; &#946; * y + z) ys) b
        . over (chunkDown innerSize) (\r -&gt; &#945; * VU.sum (VU.zipWith (*) r x))
        $ a
      where
        innerSize = fromIntegral $ natVal (Proxy @n)

    ger &#945; (FV xs) (FV ys) b =
          FV
        . maybe id (\(FV zs) -&gt; VU.zipWith (+) zs) b
        . VU.concatMap (\x -&gt; VU.map ((&#945; * x) *) ys)
        $ xs

    gemm
        :: forall m o n. (KnownNat m, KnownNat o, KnownNat n)
        =&gt; Double
        -&gt; FV '[m, o]
        -&gt; FV '[o, n]
        -&gt; Maybe (Double, FV '[m, n])
        -&gt; FV '[m, n]
    gemm &#945; (FV as) bs cs =
          FV
        . maybe id (uncurry f) cs
        . over (chunks innerSize) muller
        $ as
      where
        innerSize = fromIntegral $ natVal (Proxy @o)
        muller r =
            over (chunkDown innerSize) (\c -&gt; &#945; * VU.sum (VU.zipWith (*) r c))
          . getFV
          $ transp bs
        f &#946; (FV cs') = VU.zipWith (\c b -&gt; &#946; * c + b) cs'

range :: Sing ns -&gt; [Prod Finite ns]
range = \case
    SNil            -&gt; [&#216;]
    SNat `SCons` ss -&gt; (:&lt;) &lt;$&gt; finites &lt;*&gt; range ss

reIndex
    :: SingI ns
    =&gt; Prod Finite ns
    -&gt; Finite (Product ns)
reIndex = Finite . fst . unsafeReIndex sing

unsafeReIndex
    :: Sing ns
    -&gt; Prod Finite ns
    -&gt; (Integer, Integer)
unsafeReIndex = \case
    SNil -&gt; \case
      &#216;                     -&gt; (0, 1)
    SNat `SCons` ss -&gt; \case
      (i :: Finite n) :&lt; is -&gt;
        let (j, jSize) = unsafeReIndex ss is
            iSize = jSize * (fromSing (SNat @n))
        in  (j + jSize * getFinite i, iSize)

chunks
    :: (VU.Unbox a, VU.Unbox b)
    =&gt; Int
    -&gt; Traversal (VU.Vector a) (VU.Vector b) (VU.Vector a) (VU.Vector b)
chunks n f = fmap VU.concat . traverse f . unfoldr u
  where
    u xs | VU.length xs &gt;= n = Just (VU.splitAt n xs)
         | otherwise         = Nothing

chunkDown
    :: (VU.Unbox a, VU.Unbox b)
    =&gt; Int
    -&gt; Traversal (VU.Vector a) (VU.Vector b) (VU.Vector a) b
chunkDown n f = fmap VU.fromList . traverse f . unfoldr u
  where
    u xs | VU.length xs &gt;= n = Just (VU.splitAt n xs)
         | otherwise         = Nothing
</span></pre></body></html>