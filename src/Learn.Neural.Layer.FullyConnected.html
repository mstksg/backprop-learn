<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveGeneric             #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances         #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE InstanceSigs              #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase                #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses     #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds                 #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving        #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies              #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeInType                #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Layer</span><span class="hs-operator">.</span><span class="hs-identifier">FullyConnected</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>    </span><a href="Learn.Neural.Layer.FullyConnected.html#FullyConnected"><span class="hs-identifier hs-type">FullyConnected</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Generics</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Generics</span><span class="hs-operator">.</span><span class="hs-identifier">Numeric</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><a href="Learn.Neural.Layer.html"><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Neural</span><span class="hs-operator">.</span><span class="hs-identifier">Layer</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Numeric.BLAS.html"><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">BLAS</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Statistics</span><span class="hs-operator">.</span><span class="hs-identifier">Distribution</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Statistics</span><span class="hs-operator">.</span><span class="hs-identifier">Distribution</span><span class="hs-operator">.</span><span class="hs-identifier">Normal</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Generics</span><span class="hs-operator">.</span><span class="hs-identifier">SOP</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SOP</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">data</span><span> </span><a name="FullyConnected"><a href="Learn.Neural.Layer.FullyConnected.html#FullyConnected"><span class="hs-identifier">FullyConnected</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679306298"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-char">'[o,i]), Num (b '[o])) =&gt; Num (CParam FullyConnected b '[i] '[o]) where
    FCP w1 b1 + FCP w2 b2 = FCP (w1 + w2) (b1 + b2)
    FCP w1 b1 - FCP w2 b2 = FCP (w1 - w2) (b1 - b2)
    FCP w1 b1 * FCP w2 b2 = FCP (w1 * w2) (b1 * b2)
    negate (FCP w b) = FCP (negate w) (negate b)
    signum (FCP w b) = FCP (signum w) (signum b)
    abs    (FCP w b) = FCP (abs    w) (abs    b)
    fromInteger x = FCP (fromInteger x) (fromInteger x)

instance (Fractional (b '[o,i]), Fractional (b '[o])) =&gt; Fractional (CParam FullyConnected b '[i] '[o]) where
    FCP w1 b1 / FCP w2 b2 = FCP (w1 / w2) (b1 / b2)
    recip (FCP w b)       = FCP (recip w) (recip b)
    fromRational x        = FCP (fromRational x) (fromRational x)

instance (Floating (b '[o,i]), Floating (b '[o])) =&gt; Floating (CParam FullyConnected b '[i] '[o]) where
    sqrt (FCP w b)       = FCP (sqrt w) (sqrt b)

instance Num (CState FullyConnected b '[i] '[o]) where
    _ + _         = FCS
    _ * _         = FCS
    _ - _         = FCS
    negate _      = FCS
    abs    _      = FCS
    signum _      = FCS
    fromInteger _ = FCS

instance Fractional (CState FullyConnected b '[i] '[o]) where
    _ / _          = FCS
    recip _        = FCS
    fromRational _ = FCS

instance Floating (CState FullyConnected b '[i] '[o]) where
    sqrt _ = FCS





deriving instance Generic (CParam FullyConnected b '[i] '[o])
instance SOP.Generic (CParam FullyConnected b '[i] '[o])

instance (BLAS b, KnownNat i, KnownNat o, Floating (b '[o,i]), Floating (b '[o]))
        =&gt; Component FullyConnected b '[i] '[o] where
    data CParam  FullyConnected b '[i] '[o] =
            FCP { _fcWeights :: !(b '[o,i])
                , _fcBiases  :: !(b '[o])
                }
    data CState  FullyConnected b '[i] '[o] = FCS
    type CConstr FullyConnected b '[i] '[o] = Num (b '[o,i])
    data CConf   FullyConnected b '[i] '[o] = forall d. ContGen d =&gt; FCC d

    componentOp = componentOpDefault

    initParam = \case
      i `SCons` SNil -&gt; \case
        so@(o `SCons` SNil) -&gt; \(FCC d) g -&gt; do
          w &lt;- genA (o `SCons` (i `SCons` SNil)) $ \_ -&gt;
            realToFrac &lt;$&gt; genContVar d g
          b &lt;- genA so $ \_ -&gt;
            realToFrac &lt;$&gt; genContVar d g
          return $ FCP w b
        _ -&gt; error &quot;inaccessible.&quot;
      _ -&gt; error &quot;inaccessible.&quot;

    initState _ _ _ _ = return FCS

    defConf = FCC (normalDistr 0 0.5)

instance (BLAS b, KnownNat i, KnownNat o, Floating (b '[o,i]), Floating (b '[o]))
        =&gt; ComponentFF FullyConnected b '[i] '[o] where
    componentOpFF = bpOp . withInps $ \(x :&lt; p :&lt; &#216;) -&gt; do
        w :&lt; b :&lt; &#216; &lt;- gTuple #&lt;~ p
        y &lt;- matVecOp ~$ (w :&lt; x :&lt; &#216;)
        z &lt;- (+.)     ~$ (y :&lt; b :&lt; &#216;)
        return . only $ z

instance (BLAS b, KnownNat i, KnownNat o, Floating (b '[o,i]), Floating (b '[o]))
        =&gt; ComponentLayer r FullyConnected b '[i] '[o] where
    componentRunMode = RMIsFF
</span></pre></body></html>