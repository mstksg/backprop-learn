<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds             #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances     #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE GADTs                 #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures        #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase            #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes            #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications      #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeInType            #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators         #-}</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Backprop</span><span class="hs-operator">.</span><span class="hs-identifier">Learn</span><span class="hs-operator">.</span><span class="hs-identifier">Function</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-comment">-- module Backprop.Learn.Function (</span><span>
</span><a name="line-19"></a><span class="hs-comment">--     FixedFunc(..)</span><span>
</span><a name="line-20"></a><span class="hs-comment">--   , ParamFunc(..), compPF, parPF, idPF, fixedParam, learnParam</span><span>
</span><a name="line-21"></a><span class="hs-comment">--   , nilPF, (-~&gt;), (-!&gt;), (-&gt;!), (-++)</span><span>
</span><a name="line-22"></a><span class="hs-comment">--   , softMax</span><span>
</span><a name="line-23"></a><span class="hs-comment">--   , logisticFunc, scaleFunc, tanhFunc, mapFunc, reLU, eLU</span><span>
</span><a name="line-24"></a><span class="hs-comment">--   , pScale, pMap</span><span>
</span><a name="line-25"></a><span class="hs-comment">--   ) where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-comment">-- import           Backprop.Learn</span><span>
</span><a name="line-28"></a><span class="hs-comment">-- import           Control.Category</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- import           Control.Monad.Primitive</span><span>
</span><a name="line-30"></a><span class="hs-comment">-- import           Data.Type.Length</span><span>
</span><a name="line-31"></a><span class="hs-comment">-- import           GHC.TypeNats</span><span>
</span><a name="line-32"></a><span class="hs-comment">-- import           Numeric.Backprop</span><span>
</span><a name="line-33"></a><span class="hs-comment">-- import           Numeric.Backprop.Tuple</span><span>
</span><a name="line-34"></a><span class="hs-comment">-- import           Numeric.LinearAlgebra.Static.Backprop</span><span>
</span><a name="line-35"></a><span class="hs-comment">-- import           Prelude hiding                        ((.), id)</span><span>
</span><a name="line-36"></a><span class="hs-comment">-- import           Statistics.Distribution</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- import           Type.Class.Known</span><span>
</span><a name="line-38"></a><span class="hs-comment">-- import           Type.Family.List</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- import qualified System.Random.MWC                     as MWC</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-comment">-- newtype FixedFunc a b =</span><span>
</span><a name="line-42"></a><span class="hs-comment">--     FF { runFixedFunc :: forall s. Reifies s W =&gt; BVar s a -&gt; BVar s b }</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-comment">-- instance (Num a, Num b) =&gt; Learn NoParam a b (FixedFunc a b) where</span><span>
</span><a name="line-45"></a><span class="hs-comment">--     runFixed f _ = runFixedFunc f</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- instance Category FixedFunc where</span><span>
</span><a name="line-48"></a><span class="hs-comment">--     id = FF id</span><span>
</span><a name="line-49"></a><span class="hs-comment">--     f . g = FF $ runFixedFunc f . runFixedFunc g</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">-- data ParamFunc p a b =</span><span>
</span><a name="line-52"></a><span class="hs-comment">--     PF { _pfInit :: forall m. PrimMonad m =&gt; MWC.Gen (PrimState m) -&gt; m p</span><span>
</span><a name="line-53"></a><span class="hs-comment">--        , _pfFunc :: forall s. Reifies s W =&gt; BVar s p -&gt; BVar s a -&gt; BVar s b</span><span>
</span><a name="line-54"></a><span class="hs-comment">--        }</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">-- instance (Num p, Num a, Num b) =&gt; Learn p a b (ParamFunc p a b) where</span><span>
</span><a name="line-57"></a><span class="hs-comment">--     initParam = _pfInit</span><span>
</span><a name="line-58"></a><span class="hs-comment">--     runFixed  = _pfFunc</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- instance Num p =&gt; Category (ParamFunc p) where</span><span>
</span><a name="line-61"></a><span class="hs-comment">--     id = PF { _pfInit = const (pure 0)</span><span>
</span><a name="line-62"></a><span class="hs-comment">--             , _pfFunc = const id</span><span>
</span><a name="line-63"></a><span class="hs-comment">--             }</span><span>
</span><a name="line-64"></a><span class="hs-comment">--     f . g = PF { _pfInit = \gen -&gt; (+) &lt;$&gt; _pfInit f gen &lt;*&gt; _pfInit g gen</span><span>
</span><a name="line-65"></a><span class="hs-comment">--                , _pfFunc = \p -&gt; _pfFunc f p . _pfFunc g p</span><span>
</span><a name="line-66"></a><span class="hs-comment">--                }</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- learnParam</span><span>
</span><a name="line-69"></a><span class="hs-comment">--     :: Learn p a b l</span><span>
</span><a name="line-70"></a><span class="hs-comment">--     =&gt; l</span><span>
</span><a name="line-71"></a><span class="hs-comment">--     -&gt; ParamFunc p a b</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- learnParam l = PF { _pfInit = initParam l</span><span>
</span><a name="line-73"></a><span class="hs-comment">--                   , _pfFunc = runFixed l</span><span>
</span><a name="line-74"></a><span class="hs-comment">--                   }</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-comment">-- fixedParam</span><span>
</span><a name="line-77"></a><span class="hs-comment">--     :: FixedFunc a b</span><span>
</span><a name="line-78"></a><span class="hs-comment">--     -&gt; ParamFunc NoParam a b</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- fixedParam f = PF { _pfInit = const (pure NoParam)</span><span>
</span><a name="line-80"></a><span class="hs-comment">--                  , _pfFunc = \_ -&gt; runFixedFunc f</span><span>
</span><a name="line-81"></a><span class="hs-comment">--                  }</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-- idPF :: ParamFunc NoParam a a</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- idPF = fixedParam id</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">-- compPF</span><span>
</span><a name="line-87"></a><span class="hs-comment">--     :: (Num p, Num q)</span><span>
</span><a name="line-88"></a><span class="hs-comment">--     =&gt; ParamFunc p b c</span><span>
</span><a name="line-89"></a><span class="hs-comment">--     -&gt; ParamFunc q a b</span><span>
</span><a name="line-90"></a><span class="hs-comment">--     -&gt; ParamFunc (T2 p q) a c</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- compPF f g = PF { _pfInit = \gen -&gt; T2 &lt;$&gt; _pfInit f gen &lt;*&gt; _pfInit g gen</span><span>
</span><a name="line-92"></a><span class="hs-comment">--                 , _pfFunc = \p   -&gt; _pfFunc f (p ^^. t2_1)</span><span>
</span><a name="line-93"></a><span class="hs-comment">--                                   . _pfFunc g (p ^^. t2_2)</span><span>
</span><a name="line-94"></a><span class="hs-comment">--                 }</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-comment">-- parPF</span><span>
</span><a name="line-97"></a><span class="hs-comment">--     :: (Num p, Num q, Num a, Num b, Num c, Num d)</span><span>
</span><a name="line-98"></a><span class="hs-comment">--     =&gt; ParamFunc p a c</span><span>
</span><a name="line-99"></a><span class="hs-comment">--     -&gt; ParamFunc q b d</span><span>
</span><a name="line-100"></a><span class="hs-comment">--     -&gt; ParamFunc (T2 p q) (T2 a b) (T2 c d)</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- parPF f g = PF { _pfInit = \gen -&gt; T2 &lt;$&gt; _pfInit f gen &lt;*&gt; _pfInit g gen</span><span>
</span><a name="line-102"></a><span class="hs-comment">--                , _pfFunc = \p x -&gt; isoVar2 T2 t2Tup</span><span>
</span><a name="line-103"></a><span class="hs-comment">--                     (_pfFunc f (p ^^. t2_1) (x ^^. t2_1))</span><span>
</span><a name="line-104"></a><span class="hs-comment">--                     (_pfFunc g (p ^^. t2_2) (x ^^. t2_2))</span><span>
</span><a name="line-105"></a><span class="hs-comment">--                }</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- nilPF :: ParamFunc (T '[]) a a</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- nilPF = PF { _pfInit = const (pure TNil)</span><span>
</span><a name="line-110"></a><span class="hs-comment">--            , _pfFunc = const id</span><span>
</span><a name="line-111"></a><span class="hs-comment">--            }</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-comment">-- (-~&gt;)</span><span>
</span><a name="line-114"></a><span class="hs-comment">--     :: (Known Length ps, ListC (Num &lt;$&gt; ps), Num p)</span><span>
</span><a name="line-115"></a><span class="hs-comment">--     =&gt; ParamFunc p a b</span><span>
</span><a name="line-116"></a><span class="hs-comment">--     -&gt; ParamFunc (T ps) b c</span><span>
</span><a name="line-117"></a><span class="hs-comment">--     -&gt; ParamFunc (T (p ': ps)) a c</span><span>
</span><a name="line-118"></a><span class="hs-comment">-- f -~&gt; fs = PF { _pfInit = \g  -&gt; (:&amp;) &lt;$&gt; _pfInit f g &lt;*&gt; _pfInit fs g</span><span>
</span><a name="line-119"></a><span class="hs-comment">--               , _pfFunc = \ps -&gt; _pfFunc fs (ps ^^. tTail)</span><span>
</span><a name="line-120"></a><span class="hs-comment">--                                . _pfFunc f  (ps ^^. tHead)</span><span>
</span><a name="line-121"></a><span class="hs-comment">--               }</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- infixr 5 -~&gt;</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- (-!&gt;)</span><span>
</span><a name="line-125"></a><span class="hs-comment">--     :: FixedFunc a b</span><span>
</span><a name="line-126"></a><span class="hs-comment">--     -&gt; ParamFunc p b c</span><span>
</span><a name="line-127"></a><span class="hs-comment">--     -&gt; ParamFunc p a c</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- f -!&gt; g = PF { _pfInit = _pfInit g</span><span>
</span><a name="line-129"></a><span class="hs-comment">--              , _pfFunc = \p -&gt; _pfFunc g p . runFixedFunc f</span><span>
</span><a name="line-130"></a><span class="hs-comment">--              }</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- infixr 5 -!&gt;</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-comment">-- (-&gt;!)</span><span>
</span><a name="line-134"></a><span class="hs-comment">--     :: ParamFunc p a b</span><span>
</span><a name="line-135"></a><span class="hs-comment">--     -&gt; FixedFunc b c</span><span>
</span><a name="line-136"></a><span class="hs-comment">--     -&gt; ParamFunc p a c</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- f -&gt;! g = PF { _pfInit = _pfInit f</span><span>
</span><a name="line-138"></a><span class="hs-comment">--              , _pfFunc = \p -&gt; runFixedFunc g . _pfFunc f p</span><span>
</span><a name="line-139"></a><span class="hs-comment">--              }</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- infixr 5 -&gt;!</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- (-++)</span><span>
</span><a name="line-143"></a><span class="hs-comment">--     :: forall ps qs a b c. (Known Length ps, Known Length qs, ListC (Num &lt;$&gt; ps), ListC (Num &lt;$&gt; qs))</span><span>
</span><a name="line-144"></a><span class="hs-comment">--     =&gt; ParamFunc (T ps) a b</span><span>
</span><a name="line-145"></a><span class="hs-comment">--     -&gt; ParamFunc (T qs) b c</span><span>
</span><a name="line-146"></a><span class="hs-comment">--     -&gt; ParamFunc (T (ps ++ qs)) a c</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- fs -++ gs = PF { _pfInit = \g  -&gt; tAppend &lt;$&gt; _pfInit fs g &lt;*&gt; _pfInit gs g</span><span>
</span><a name="line-148"></a><span class="hs-comment">--                , _pfFunc = \ps -&gt; _pfFunc gs (ps ^^. tDrop @ps @qs known)</span><span>
</span><a name="line-149"></a><span class="hs-comment">--                                 . _pfFunc fs (ps ^^. tTake @ps @qs known)</span><span>
</span><a name="line-150"></a><span class="hs-comment">--                }</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- infixr 5 -++</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- softMax :: KnownNat i =&gt; FixedFunc (R i) (R i)</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- softMax = FF $ \x -&gt;  let expx = exp x</span><span>
</span><a name="line-155"></a><span class="hs-comment">--                       in  expx / konst (norm_1V expx)</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-comment">-- logisticFunc :: Floating a =&gt; FixedFunc a a</span><span>
</span><a name="line-159"></a><span class="hs-comment">-- logisticFunc = FF $ \x -&gt; 1 / (1 + exp (-x))</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-comment">-- scaleFunc :: Num a =&gt; a -&gt; FixedFunc a a</span><span>
</span><a name="line-162"></a><span class="hs-comment">-- scaleFunc c = FF (* constVar c)</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-comment">-- tanhFunc :: Floating a =&gt; FixedFunc a a</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- tanhFunc = FF tanh</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-comment">-- mapFunc</span><span>
</span><a name="line-168"></a><span class="hs-comment">--     :: KnownNat i</span><span>
</span><a name="line-169"></a><span class="hs-comment">--     =&gt; (forall s. Reifies s W =&gt; BVar s Double -&gt; BVar s Double)</span><span>
</span><a name="line-170"></a><span class="hs-comment">--     -&gt; FixedFunc (R i) (R i)</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- mapFunc f = FF (vmap' f)</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-comment">-- reLU :: KnownNat i =&gt; FixedFunc (R i) (R i)</span><span>
</span><a name="line-174"></a><span class="hs-comment">-- reLU = mapFunc $ \x -&gt; if x &lt; 0 then 0 else x</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-comment">-- eLU :: KnownNat i =&gt; FixedFunc (R i) (R i)</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- eLU = mapFunc $ \x -&gt; if x &lt; 0 then exp x - 1 else x</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-comment">-- pScale :: (KnownNat i, ContGen d) =&gt; d -&gt; ParamFunc Double (R i) (R i)</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- pScale d = PF { _pfInit = genContVar d</span><span>
</span><a name="line-181"></a><span class="hs-comment">--               , _pfFunc = \p x -&gt; konst p * x</span><span>
</span><a name="line-182"></a><span class="hs-comment">--               }</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-comment">-- pMap</span><span>
</span><a name="line-185"></a><span class="hs-comment">--     :: KnownNat i</span><span>
</span><a name="line-186"></a><span class="hs-comment">--     =&gt; (forall m. PrimMonad m =&gt; MWC.Gen (PrimState m) -&gt; m p)</span><span>
</span><a name="line-187"></a><span class="hs-comment">--     -&gt; (forall s. Reifies s W =&gt; BVar s p -&gt; BVar s Double -&gt; BVar s Double)</span><span>
</span><a name="line-188"></a><span class="hs-comment">--     -&gt; ParamFunc p (R i) (R i)</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- pMap i f = PF { _pfInit = i</span><span>
</span><a name="line-190"></a><span class="hs-comment">--               , _pfFunc = \p -&gt; vmap (f p)</span><span>
</span><a name="line-191"></a><span class="hs-comment">--               }</span><span>
</span><a name="line-192"></a></pre></body></html>