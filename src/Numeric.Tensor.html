<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds           #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeInType          #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Tensor</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>    </span><a href="Numeric.Tensor.html#Tensor"><span class="hs-identifier hs-type">Tensor</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#tmapOp"><span class="hs-identifier hs-var">tmapOp</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#tzipNOp"><span class="hs-identifier hs-var">tzipNOp</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#tkonstOp"><span class="hs-identifier hs-var">tkonstOp</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#tsumOp"><span class="hs-identifier hs-var">tsumOp</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#scaleOp"><span class="hs-identifier hs-var">scaleOp</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#oneHot"><span class="hs-identifier hs-var">oneHot</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Reflection</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-keyword">hiding</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head'</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">AD</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">AD</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Reverse</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">AD</span><span class="hs-operator">.</span><span class="hs-identifier">Mode</span><span class="hs-operator">.</span><span class="hs-identifier">Forward</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Forward</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span class="hs-operator">.</span><span class="hs-identifier">Op</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Higher</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Known</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Nat</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TCN</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SingKind</span><span> </span><a href="#local-6989586621679196152"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RealFloat</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq1</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#IndexT"><span class="hs-identifier hs-type">IndexT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a name="Tensor"><a href="Numeric.Tensor.html#Tensor"><span class="hs-identifier">Tensor</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679196153"><a href="#local-6989586621679196153"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679196152"><span class="hs-identifier hs-type">k</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-37"></a><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">IndexT</span><span> </span><a name="local-6989586621679196153"><a href="#local-6989586621679196153"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679196152"><span class="hs-identifier hs-type">k</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-38"></a><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">ElemT</span><span>  </span><a name="local-6989586621679196153"><a href="#local-6989586621679196153"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>    </span><span class="hs-identifier">genA</span><span>
</span><a name="line-41"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679196154"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-42"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-6989586621679196155"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-43"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#IndexT"><span class="hs-identifier hs-type">IndexT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196155"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196154"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196154"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196155"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span>    </span><span class="hs-identifier">gen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-6989586621679196156"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-47"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#IndexT"><span class="hs-identifier hs-type">IndexT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196156"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196156"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-49"></a><span>    </span><a name="local-8214565720323971049"><a href="Numeric.Tensor.html#gen"><span class="hs-identifier">gen</span></a></a><span> </span><a name="local-6989586621679196165"><a href="#local-6989586621679196165"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679196166"><a href="#local-6989586621679196166"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">getI</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Numeric.Tensor.html#genA"><span class="hs-identifier hs-var">genA</span></a><span> </span><a href="#local-6989586621679196165"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679196166"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-identifier">tkonst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-6989586621679196157"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196157"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-52"></a><span>    </span><a name="local-8214565720323971050"><a href="Numeric.Tensor.html#tkonst"><span class="hs-identifier">tkonst</span></a></a><span> </span><a name="local-6989586621679196167"><a href="#local-6989586621679196167"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679196168"><a href="#local-6989586621679196168"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.Tensor.html#gen"><span class="hs-identifier hs-var">gen</span></a><span> </span><a href="#local-6989586621679196167"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196168"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span>    </span><span class="hs-identifier">tsum</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679196158"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196158"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-55"></a><span>    </span><span class="hs-identifier">tmap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679196159"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196159"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196159"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-56"></a><span>    </span><a name="local-8214565720323971052"><a href="Numeric.Tensor.html#tmap"><span class="hs-identifier">tmap</span></a></a><span> </span><a name="local-6989586621679196169"><a href="#local-6989586621679196169"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679196170"><a href="#local-6989586621679196170"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.Tensor.html#tzipN"><span class="hs-identifier hs-var">tzipN</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">I</span><span> </span><a name="local-6989586621679196171"><a href="#local-6989586621679196171"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">&#216;V</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196169"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679196171"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679196170"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">&#216;V</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>    </span><span class="hs-identifier">tzip</span><span>
</span><a name="line-59"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679196160"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-60"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196160"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-62"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196160"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-63"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196160"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-64"></a><span>    </span><a name="local-8214565720323971053"><a href="Numeric.Tensor.html#tzip"><span class="hs-identifier">tzip</span></a></a><span> </span><a name="local-6989586621679196172"><a href="#local-6989586621679196172"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679196173"><a href="#local-6989586621679196173"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679196174"><a href="#local-6989586621679196174"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.Tensor.html#tzipN"><span class="hs-identifier hs-var">tzipN</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">I</span><span> </span><a name="local-6989586621679196175"><a href="#local-6989586621679196175"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">I</span><span> </span><a name="local-6989586621679196176"><a href="#local-6989586621679196176"><span class="hs-identifier">y'</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">&#216;V</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196172"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679196175"><span class="hs-identifier hs-var">x'</span></a><span> </span><a href="#local-6989586621679196176"><span class="hs-identifier hs-var">y'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679196173"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><a href="#local-6989586621679196174"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">&#216;V</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>    </span><span class="hs-identifier">tzipN</span><span>
</span><a name="line-67"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679196161"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-68"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vec</span><span> </span><a href="#local-6989586621679196162"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VecT</span><span> </span><a href="#local-6989586621679196162"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196161"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-70"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196161"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-71"></a><span>    </span><a name="local-8214565720323971054"><a href="Numeric.Tensor.html#tzipN"><span class="hs-identifier">tzipN</span></a></a><span> </span><a name="local-6989586621679196177"><a href="#local-6989586621679196177"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679196178"><a href="#local-6989586621679196178"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.Tensor.html#gen"><span class="hs-identifier hs-var">gen</span></a><span> </span><span class="hs-identifier hs-var">sing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679196179"><a href="#local-6989586621679196179"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-72"></a><span>        </span><a href="#local-6989586621679196177"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Numeric.Tensor.html#tindex"><span class="hs-identifier hs-var">tindex</span></a><span> </span><a href="#local-6989586621679196179"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679196178"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>    </span><span class="hs-identifier">tsize</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679196163"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-76"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196163"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-77"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-identifier">tindex</span><span>
</span><a name="line-80"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679196164"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-81"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Numeric.Tensor.html#IndexT"><span class="hs-identifier hs-type">IndexT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196164"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-82"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679196164"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-83"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196153"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span>    </span><span class="hs-pragma">{-# MINIMAL genA, tsum, tsize, tindex #-}</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-identifier">tmapOp</span><span>
</span><a name="line-88"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#Tensor"><span class="hs-identifier hs-type">Tensor</span></a><span> </span><a href="#local-6989586621679196193"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679196194"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679196195"><a href="#local-6989586621679196195"><span class="hs-identifier">q</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">AD</span><span> </span><a href="#local-6989586621679196195"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Forward</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196193"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AD</span><span> </span><a href="#local-6989586621679196195"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Forward</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-6989586621679196193"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Op</span><span> </span><span class="hs-char">'[t s] '[t s]
tmapOp f = op1' $ \x -&gt;
    let y  = tmap (fst . diff' f) x
        dy = tmap (diff f) x
    in  (only_ y, maybe dy (tzip (*) dy) . head')

tzipNOp
    :: forall k t (s :: k) n. (Tensor t, SingI s, Known TCN.Nat n)
    =&gt; (forall q. Reifies q Tape =&gt; Vec n (Reverse q (ElemT t)) -&gt; Reverse q (ElemT t))
    -&gt; Op (Replicate n (t s)) '[t s]
tzipNOp f = Op $ \xs -&gt;
    let n :: TCN.Nat n
        n = known
        xs' = vmap getI . prodToVec' n $ xs
        y   = tzipN (fst . grad' f) xs'
        dy  = vgen n $ \i -&gt; I $ tzipN (index' i . grad f) xs'
    in  (only_ y, vecToProd . maybe dy (\g -&gt; tzip (*) g &lt;$&gt; dy) . head')

tkonstOp :: forall t s. Tensor t =&gt; Sing s -&gt; Op '[ElemT t] '[t s]
tkonstOp s = withSingI s $ op1' $ \x -&gt;
    let res = tkonst s x
    in  (only_ res, maybe (fromIntegral (tsize res)) tsum . head')

tsumOp
    :: forall t s. (Tensor t, SingI s)
    =&gt; Op '[ t s ] '[ ElemT t ]
tsumOp = op1' $ \x -&gt;
    ( only_ (tsum x)
    , \case Nothing :&lt; &#216; -&gt; tkonst sing 1
            Just g  :&lt; &#216; -&gt; tkonst sing g 
    )

scaleOp
    :: forall t s. (Tensor t, SingI s, Num (t s))
    =&gt; Op '[ ElemT t, t s ] '[ t s ]
scaleOp = op2' $ \&#945; x -&gt;
    ( only_ (tmap (&#945; *) x)
    , \case Nothing :&lt; &#216; -&gt; (tsum x      , tkonst sing &#945;    )
            Just g  :&lt; &#216; -&gt; (tsum (x * g), tkonst sing &#945; * g)
    )

oneHot :: (Tensor t, SingI s) =&gt; IndexT t s -&gt; t s
oneHot i = gen sing $ \j -&gt; if i `eq1` j then 1 else 0
</span></pre></body></html>