<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances     #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE GADTs                 #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase            #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds             #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes            #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications      #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies          #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeInType            #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators         #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances  #-}</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Tensor</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-16"></a><span>    </span><a href="Numeric.Tensor.html#Tensor"><span class="hs-identifier hs-type">Tensor</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#DoubleProd"><span class="hs-identifier hs-type">DoubleProd</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#Product"><span class="hs-identifier hs-type">Product</span></a><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#sProduct"><span class="hs-identifier hs-var">sProduct</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#fromScalar"><span class="hs-identifier hs-var">fromScalar</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#toScalar"><span class="hs-identifier hs-var">toScalar</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#fromList%27"><span class="hs-identifier hs-var">fromList'</span></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#tmapOp"><span class="hs-identifier hs-var">tmapOp</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#tzipNOp"><span class="hs-identifier hs-var">tzipNOp</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#tkonstOp"><span class="hs-identifier hs-var">tkonstOp</span></a><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#tsumOp"><span class="hs-identifier hs-var">tsumOp</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#scaleOp"><span class="hs-identifier hs-var">scaleOp</span></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Numeric.Tensor.html#oneHot"><span class="hs-identifier hs-var">oneHot</span></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Finite</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Finite</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Reflection</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Reverse</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>  </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-keyword">hiding</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head'</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TL</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">AD</span><span> </span><span class="hs-keyword">hiding</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Scalar</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">AD</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Reverse</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">AD</span><span class="hs-operator">.</span><span class="hs-identifier">Mode</span><span class="hs-operator">.</span><span class="hs-identifier">Forward</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Forward</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Backprop</span><span class="hs-operator">.</span><span class="hs-identifier">Op</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Higher</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Known</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Nat</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TCN</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Sized</span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">V</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-keyword">class</span><span> </span><span class="hs-identifier hs-type">RealFloat</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a name="Tensor"><a href="Numeric.Tensor.html#Tensor"><span class="hs-identifier">Tensor</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679156033"><a href="#local-6989586621679156033"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-comment">-- type IndexT t :: k -&gt; Type</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Scalar</span><span> </span><a name="local-6989586621679156033"><a href="#local-6989586621679156033"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>    </span><span class="hs-identifier">genA</span><span>
</span><a name="line-60"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679156034"><a href="#local-6989586621679156034"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679156035"><a href="#local-6989586621679156035"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679156034"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-61"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-6989586621679156035"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-62"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Prod</span><span> </span><span class="hs-identifier hs-type">Finite</span><span> </span><a href="#local-6989586621679156035"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156034"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156034"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156035"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-identifier">gen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679156036"><a href="#local-6989586621679156036"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-6989586621679156036"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-66"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Prod</span><span> </span><span class="hs-identifier hs-type">Finite</span><span> </span><a href="#local-6989586621679156036"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156036"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-68"></a><span>    </span><a name="local-8214565720323930911"><a href="Numeric.Tensor.html#gen"><span class="hs-identifier">gen</span></a></a><span> </span><a name="local-6989586621679156052"><a href="#local-6989586621679156052"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679156053"><a href="#local-6989586621679156053"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">getI</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Numeric.Tensor.html#genA"><span class="hs-identifier hs-var">genA</span></a><span> </span><a href="#local-6989586621679156052"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679156053"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span>    </span><span class="hs-identifier">tkonst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-6989586621679156037"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156037"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-71"></a><span>    </span><a name="local-8214565720323930912"><a href="Numeric.Tensor.html#tkonst"><span class="hs-identifier">tkonst</span></a></a><span> </span><a name="local-6989586621679156054"><a href="#local-6989586621679156054"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679156055"><a href="#local-6989586621679156055"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.Tensor.html#gen"><span class="hs-identifier hs-var">gen</span></a><span> </span><a href="#local-6989586621679156054"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156055"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span>    </span><span class="hs-identifier">tsum</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679156038"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156038"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-74"></a><span>    </span><span class="hs-identifier">tmap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679156039"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156039"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156039"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-75"></a><span>    </span><a name="local-8214565720323930914"><a href="Numeric.Tensor.html#tmap"><span class="hs-identifier">tmap</span></a></a><span> </span><a name="local-6989586621679156056"><a href="#local-6989586621679156056"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679156057"><a href="#local-6989586621679156057"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.Tensor.html#tzipN"><span class="hs-identifier hs-var">tzipN</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">I</span><span> </span><a name="local-6989586621679156058"><a href="#local-6989586621679156058"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">&#216;V</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156056"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679156058"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679156057"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">&#216;V</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span>    </span><span class="hs-identifier">tzip</span><span>
</span><a name="line-78"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679156040"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-79"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156040"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-81"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156040"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-82"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156040"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-83"></a><span>    </span><a name="local-8214565720323930915"><a href="Numeric.Tensor.html#tzip"><span class="hs-identifier">tzip</span></a></a><span> </span><a name="local-6989586621679156059"><a href="#local-6989586621679156059"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679156060"><a href="#local-6989586621679156060"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679156061"><a href="#local-6989586621679156061"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.Tensor.html#tzipN"><span class="hs-identifier hs-var">tzipN</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">I</span><span> </span><a name="local-6989586621679156062"><a href="#local-6989586621679156062"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">I</span><span> </span><a name="local-6989586621679156063"><a href="#local-6989586621679156063"><span class="hs-identifier">y'</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">&#216;V</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156059"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679156062"><span class="hs-identifier hs-var">x'</span></a><span> </span><a href="#local-6989586621679156063"><span class="hs-identifier hs-var">y'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679156060"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><a href="#local-6989586621679156061"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-identifier hs-var">&#216;V</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span>    </span><span class="hs-identifier">tzipN</span><span>
</span><a name="line-86"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679156041"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-87"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vec</span><span> </span><a href="#local-6989586621679156042"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-special">(</span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VecT</span><span> </span><a href="#local-6989586621679156042"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156041"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-89"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156041"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-90"></a><span>    </span><a name="local-8214565720323930916"><a href="Numeric.Tensor.html#tzipN"><span class="hs-identifier">tzipN</span></a></a><span> </span><a name="local-6989586621679156064"><a href="#local-6989586621679156064"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679156065"><a href="#local-6989586621679156065"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Numeric.Tensor.html#gen"><span class="hs-identifier hs-var">gen</span></a><span> </span><span class="hs-identifier hs-var">sing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679156066"><a href="#local-6989586621679156066"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-91"></a><span>        </span><a href="#local-6989586621679156064"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Numeric.Tensor.html#tindex"><span class="hs-identifier hs-var">tindex</span></a><span> </span><a href="#local-6989586621679156066"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679156065"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span>    </span><span class="hs-identifier">tsize</span><span>
</span><a name="line-94"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679156043"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-95"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156043"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-96"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-identifier">tindex</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><a href="#local-6989586621679156044"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-100"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Prod</span><span> </span><span class="hs-identifier hs-type">Finite</span><span> </span><a href="#local-6989586621679156044"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-101"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679156044"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-102"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Numeric.Tensor.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>    </span><span class="hs-identifier">tconv</span><span>
</span><a name="line-105"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">KnownNat</span><span> </span><a href="#local-6989586621679156045"><span class="hs-identifier hs-type">n</span></a><span>
</span><a name="line-106"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Numeric.Tensor.html#DoubleProd"><span class="hs-identifier hs-type">DoubleProd</span></a><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-6989586621679156046"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679156047"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-107"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679156033"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679156045"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-char">': m)
        -&gt; t s
        -&gt; t (n ': s)

    treshape
        :: (SingI s1, Product s1 ~ Product s2)
        =&gt; Sing s2
        -&gt; t s1
        -&gt; t s2
    treshape s = tload s . textract

    tload
        :: Sing s
        -&gt; V.Vector (Product s) (Scalar t)
        -&gt; t s
    tload s = fromJust . fromList' s . toList

    textract
        :: SingI s
        =&gt; t s
        -&gt; V.Vector (Product s) (Scalar t)

    {-# MINIMAL genA, tsum, tsize, tindex, tconv, textract #-}

type family Product (ns :: [Nat]) :: Nat where
    Product '[]       = 1
    Product (n ': ns) = n TL.* (Product ns)

sProduct :: Sing as -&gt; Sing (Product as)
sProduct = \case
    SNil -&gt; SNat
    s `SCons` ss -&gt; s %:* sProduct ss

data DoubleProd :: (k -&gt; Type) -&gt; [k] -&gt; [k] -&gt; Type where
    DPZ :: DoubleProd f '[] '[]
    DPS :: f a -&gt; f b -&gt; DoubleProd f as bs -&gt; DoubleProd f (a ': as) (b ': bs)

instance Known (DoubleProd f '[]) '[] where
    known = DPZ

instance (Known (DoubleProd f as) bs, Known f a, Known f b) =&gt; Known (DoubleProd f (a ': as)) (b ': bs) where
    known = DPS known known known

fromScalar :: Tensor t =&gt; Scalar t -&gt; t '[]
fromScalar x = gen SNil (\_ -&gt; x)

toScalar :: Tensor t =&gt; t '[] -&gt; Scalar t
toScalar = tindex &#216;

fromList'
    :: Tensor t
    =&gt; Sing s
    -&gt; [Scalar t]
    -&gt; Maybe (t s)
fromList' s = evalStateT . genA s $ \_ -&gt; StateT uncons

fromList
    :: Tensor t
    =&gt; Sing s
    -&gt; [Scalar t]
    -&gt; Maybe (t s)
fromList s = case sProduct s of
    SNat -&gt; fmap (tload s) . V.fromList

tmapOp
    :: (Tensor t, SingI s)
    =&gt; (forall q. AD q (Forward (Scalar t)) -&gt; AD q (Forward (Scalar t)))
    -&gt; Op '[t s] '[t s]
tmapOp f = op1' $ \x -&gt;
    let y  = tmap (fst . diff' f) x
        dy = tmap (diff f) x
    in  (only_ y, maybe dy (tzip (*) dy) . head')

tzipNOp
    :: forall t s n. (Tensor t, SingI s, Known TCN.Nat n)
    =&gt; (forall q. Reifies q Tape =&gt; Vec n (Reverse q (Scalar t)) -&gt; Reverse q (Scalar t))
    -&gt; Op (Replicate n (t s)) '[t s]
tzipNOp f = Op $ \xs -&gt;
    let n :: TCN.Nat n
        n = known
        xs' = vmap getI . prodToVec' n $ xs
        y   = tzipN (fst . grad' f) xs'
        dy  = vgen n $ \i -&gt; I $ tzipN (index' i . grad f) xs'
    in  (only_ y, vecToProd . maybe dy (\g -&gt; tzip (*) g &lt;$&gt; dy) . head')

tkonstOp :: forall t s. Tensor t =&gt; Sing s -&gt; Op '[Scalar t] '[t s]
tkonstOp s = withSingI s $ op1' $ \x -&gt;
    let res = tkonst s x
    in  (only_ res, maybe (fromIntegral (tsize res)) tsum . head')

tsumOp
    :: forall t s. (Tensor t, SingI s)
    =&gt; Op '[ t s ] '[ Scalar t ]
tsumOp = op1' $ \x -&gt;
    ( only_ (tsum x)
    , \case Nothing :&lt; &#216; -&gt; tkonst sing 1
            Just g  :&lt; &#216; -&gt; tkonst sing g
    )

scaleOp
    :: forall t s. (Tensor t, SingI s, Num (t s))
    =&gt; Op '[ Scalar t, t s ] '[ t s ]
scaleOp = op2' $ \&#945; x -&gt;
    ( only_ (tmap (&#945; *) x)
    , \case Nothing :&lt; &#216; -&gt; (tsum x      , tkonst sing &#945;    )
            Just g  :&lt; &#216; -&gt; (tsum (x * g), tkonst sing &#945; * g)
    )

oneHot :: (Tensor t, SingI s) =&gt; Prod Finite s -&gt; t s
oneHot i = gen sing $ \j -&gt; if i `eq1` j then 1 else 0

</span></pre></body></html>